
<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta charset="utf-8">
	<title>Optimizing Google Protocol Buffers with Wire | creativepsyco's Blog</title>

	<meta name="author" content="Mohit Kanwal">
	
	<meta name="description" content="A Blog of all things digital">

	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="/atom.xml" rel="alternate" title="creativepsyco's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400" />
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css" />
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body class="post-template">
  <main class="content" role="main"><article class="post">
  
	<header class="post-header">
		<a id="blog-logo" href="/">creativepsyco's Blog</a>
	</header>
	<span class="post-meta">31 Dec 2013</span>
	<h1 class="post-title">Optimizing Google Protocol Buffers With Wire</h1>

	<section class="post-content">
		<p>The concept of <a href="https://code.google.com/p/protobuf/">Protocol Buffers</a> by Google is amazing.</p>

<h3>Why should you use it</h3>

<p>Protocol Buffers is a serialization strategy, much like XML or JSON. A lot of mobile apps and web services make use of JSON for passing information. However, protocol buffers are inherently compressed formats and not intented for the human eye (readability wise). You should definitely take a look at it if you feel that you are using a lot of the mobile data or if the primary target group of your app is the domain of mobile. It however, makes sense to use them for internal RPC related APIs and communication channels.</p>

<!--more-->


<h3>Why should you not use it</h3>

<p>Having worked with protocol buffers extensively during the development of one of my company&rsquo;s Android apps, I can say that Protocol Buffers definitely can have their own problems. In an agile environment where requirements can change extensively during development, it makes no sense to actually use protocol buffers without breaking the schema. And according to Google you might not wanna change the structure of Enums. I will just summarize what <a href="http://blakesmith.me/2012/09/05/a-primer-on-protocol-buffers.html">Blake Smith</a> has to say about the anti-pattern:</p>

<p>Don&rsquo;t use Protocol Buffers <strong>IF</strong>:</p>

<blockquote><ul>
<li>You need <strong>dynamic message</strong> schemas</li>
<li>You’re sending a lot of data directly to the browser</li>
<li>You need wide-spread language support as the ability to generate protocol buffer code files is only for a limited set of languages</li>
<li>You require direct human readability</li>
</ul>
</blockquote>

<h3>Google Protocol Buffers on Android</h3>

<p>On Android there is an option to use the pure <a href="https://code.google.com/p/protobuf/downloads/list">Java version</a> or a lite version (included within the original jar) or a <a href="https://code.google.com/p/protobuf-j2me/">Java ME version</a> which reduces the generated code size. However, there is a big issue with the usage of Protocol Buffer on Android. The Android Dalvik VM only allows 60K public methods to be exposed during runtime due to the limitation of the size of the DEX class file that it cam store in memory, for Android Gingerbread, this is about 7MBs. This limit is strictly enforced on Gingerbread (Android 2.3.3) and if it is the minimum version of Android that you want to support then you are in pretty bad luck. For each attribute on the protocol buffer message file there are about 9 public methods generated and this increases for optional/repeated fields. As such a lot of code is generated which won&rsquo;t be used by large anyways in your app. On the other hand, due to the amount of public methods exposed, you run the risk of not being able to ship your app on Gingerbread.</p>

<h3>With Wire</h3>

<p>I used the Java Me version and the lite version of the protocol buffers but without any significant gains in application public method size. Then came <a href="https://github.com/square/wire">Wire</a> by Square (the company is obsessed with Android.. <a href="http://square.github.io/">check out their open source contributions</a>). Wire allowed me to reduce the number of public methods exposed in the application. The generated code definition files became so sleek that for once I could actually read them (with Google protobuf implementation, there were simply and quite literally thousands and thousands of lines to go over). The rest of the code did not need much change, just a few rewiring here and there and it was done.</p>

<h3>A note about proguard</h3>

<p>In addition you need the following proguard rules:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-keep public class * extends com.squareup.wire.**{*;}
</span><span class='line'>
</span><span class='line'># Keep methods with Wire annotations (e.g. @ProtoField)
</span><span class='line'>-keepclassmembers class ** {
</span><span class='line'>    @com.squareup.wire.ProtoField public *;
</span><span class='line'>    @com.squareup.wire.ProtoEnum public *;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Cheers</p>

	</section>

  <footer class="post-footer">
  <section class="author">
    <h4>Mohit Kanwal</h4>
    <p></p>
  </section>
  <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=Optimizing Google Protocol Buffers with Wire&amp;url=http://blog.mohitkanwal.com/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.mohitkanwal.com/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.mohitkanwal.com/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
    </a>
  </section>
</footer>
  <hr>
  
    <div class="share">
</div>

  
  
  <section id="comment">
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>
  
</article></main>
  <footer class="site-footer"><a class="subscribe icon-feed" href="http://blog.mohitkanwal.com/atom.xml"><span class="tooltip">Subscribe!</span></a>


<div class="inner">


Follow me on



<a class="social twitter" href="http://twitter.com/mohitkanwal" title="Twitter">Twitter</a>



<a class="social github" href="http://github.com/creativepsyco" title="GitHub">GitHub</a>




<section class="copyright">All content copyright <a href="/">Mohit Kanwal</a> © 2016 • All rights reserved.</section>

<section class="poweredby">Casper theme by <a class="icon-ghost" href="http://tryghost.org">Ghost</a> &amp; Published with <a href="http://octopress.org">Octopress</a></section>

</div>
</footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>



<script type="text/javascript">
      var disqus_shortname = 'creativepyscoblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.mohitkanwal.com/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/';
        var disqus_url = 'http://blog.mohitkanwal.com/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-36037120-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</body>
</html>
