
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android Activity: Problem With Posting Runnables - creativepsyco's Blog</title>
  <meta name="author" content="Mohit Kanwal">

  
  <meta name="description" content="Android Activity: Problem With Posting Runnables written Jan 5th, 2014 in android, memory-leak A lot of times in Android you end up writing code &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.mohitkanwal.com/blog/2014/01/05/android-activity-problem-with-posting-runnables">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="creativepsyco's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36037120-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Android Activity: Problem With Posting Runnables</h1>
        <div class="meta">
          written 








  



<time datetime="2014-01-05T23:44:00+08:00" pubdate data-updated="true">Jan 5<span>th</span>, 2014</time>
          

in
<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/memory-leak/'>memory-leak</a>
  
</span>


        </div>
        <p>A lot of times in Android you end up writing code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//---- Normal Code above ---</span>
</span><span class='line'><span class="n">Runnable</span> <span class="n">runnable</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Do something stupid</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="c1">// Singleton Handler Manager -- not an instance one, am I smart?</span>
</span><span class='line'><span class="n">HandlerManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span> <span class="mi">20000</span><span class="o">);</span> <span class="c1">// Run this after 20 seconds! Delay processing of data</span>
</span><span class='line'><span class="n">finish</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is, cooking up a lot of <code>Runnables</code> and posting them on the Handler to be run after a period of time. It happens.</p>

<p>As our role as developers trying to get a feature done in time, sometimes these Runnnables are the only hope. However, this <code>Runnable</code> introduces a potential memory leak.</p>

<!--more-->


<p>Android uses a Garbage Collection mechanism to reclaim allocated memory in which nodes are traversed from the root of the Collector and each node is checked for incoming references, if these references fall into a particular type of reference, <code>Final</code>, <code>Weak</code> or other types of finalized references, these nodes are freed and memory unallocated. However, if there any incoming references, then this node cannot be freed up. If you are developing a large app, you will definitely face this issue at some point or the other.</p>

<p>Now you must be asking why the above code will cause a memory leak.</p>

<p>It does as follows.</p>

<ul>
<li>When you created a Runnable, it ended up being an inner class, and all inner classes have outer class <a href="http://stackoverflow.com/questions/1816458/getting-hold-of-the-outer-class-object-from-the-inner-class-object">references</a>.</li>
<li>Now your Runnable is queued in the Singleton Handler, which is always alive in Memory</li>
<li>As such your Runnable is alive</li>
<li>And so is your Activity</li>
<li>When you call finish(), your activity is queued up to be destroyed, but the Garbage Collector finds that your Activity instance is referenced from your Runnable inner class instance and therefore does not collect its allocated memory.</li>
</ul>


<p>So hopefully, now you get it?</p>

<blockquote><p>The solution is to use static inner classes so as to avoid initialization of the instance with the outer class instance.</p>

<p>static inner classes use the class instance, not the instance reference and therefore are safe from these issues.</p></blockquote>


        <hr class="divider-short"/>

        
        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </section>
        
      </div>
    </div>
  </div>
</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/blog/2013/12/31/optimizing-google-protocol-buffers-with-wire/" title="Previous Post: Optimizing Google Protocol Buffers with Wire">&laquo; Previous: Optimizing Google Protocol Buffers with Wire</a>
        

        
          <a class="pull-right" href="/blog/2014/01/24/doing-a-proper-github-pull-request/" title="Next Post: Doing a proper Github pull request">Next: Doing a proper Github pull request &raquo;</a>
        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    
    <a href="https://twitter.com/mohitkanwal"><img src="/images/glyphicons_social_31_twitter.png"/></a>
    

    
    <a href="https://github.com/creativepsyco"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    
    <a href="https://linkedin.com/in/mskanwal"><img src="/images/glyphicons_social_17_linked_in.png"/></a>
    

    
    <a href="mailto:mohit.kanwal+blog@gmail.com"><img src="/images/glyphicons_social_39_e-mail.png"/></a>
    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

    
      

<script type="text/javascript">
      var disqus_shortname = 'creativepyscoblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.mohitkanwal.com/blog/2014/01/05/android-activity-problem-with-posting-runnables/';
        var disqus_url = 'http://blog.mohitkanwal.com/blog/2014/01/05/android-activity-problem-with-posting-runnables/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


    
  </body>
</html>
